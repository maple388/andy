<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肺气肿HRCT影像交互指南 (含AI功能)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #F8F5F2; /* Soft Beige */
            color: #3D3D3D; /* Dark Gray */
            transition: background-color 0.3s ease;
        }
        .dark-mode body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6A8EAE; /* Muted Blue-Gray */
            font-weight: 500;
        }
        .tab-button:hover, .tab-button.active {
            color: #3D3D3D; /* Dark Gray */
            border-bottom-color: #D8A77F; /* Soft Terracotta */
        }
        .dark-mode .tab-button:hover, .dark-mode .tab-button.active {
            color: #e2e8f0;
        }
        .content-section {
            display: none;
            padding-top: 1.5rem;
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 1.5rem; /* 24px */
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .dark-mode .card {
            background-color: #2d3748;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .card-title {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #6A8EAE; /* Muted Blue-Ggray */
            margin-bottom: 1rem;
            border-bottom: 2px solid #A4B8C4; /* Light Blue-Gray */
            padding-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .dark-mode .card-title {
            color: #90cdf4;
            border-bottom-color: #4a5568;
        }
        .sub-card-title {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #8AA399; /* Muted Sage Green */
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        .dark-mode .sub-card-title {
            color: #68d391;
        }
        .ai-feature-title {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #79A2A0; /* AI Accent Color - Muted Teal */
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        .dark-mode .ai-feature-title {
            color: #4fd1c5;
        }
        .highlight {
            color: #D8A77F; /* Soft Terracotta */
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .dark-mode .highlight {
            color: #f6ad55;
        }
        .table-custom {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .table-custom th, .table-custom td {
            border: 1px solid #A4B8C4; /* Light Blue-Gray */
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        .table-custom th {
            background-color: #E6EBF0; /* Lighter shade of blue-gray */
            color: #3D3D3D;
            font-weight: 600;
        }
        .dark-mode .table-custom th {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        .dark-mode .table-custom th, 
        .dark-mode .table-custom td {
            border: 1px solid #4a5568;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for readability */
            margin-left: auto;
            margin-right: auto;
            height: 350px; /* Base height */
            max-height: 400px; /* Max height */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .chart-container {
                height: 400px;
            }
        }

        .diagram-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1rem auto;
            padding: 1rem;
            border: 1px solid #A4B8C4;
            border-radius: 0.5rem;
            background-color: #FDFBF7; /* Slightly off-white for diagram bg */
            max-width: 300px;
            min-height: 150px;
            position: relative;
            transition: all 0.3s ease;
        }
        .dark-mode .diagram-container {
            border: 1px solid #4a5568;
            background-color: #2d3748;
        }
        .diagram-title {
            font-weight: 600;
            color: #6A8EAE;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .dark-mode .diagram-title {
            color: #90cdf4;
        }
        .lobule-base-interactive {
            width: 100px;
            height: 100px;
            border: 2px solid #6A8EAE;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            cursor: help;
            transition: all 0.3s ease;
        }
        .dark-mode .lobule-base-interactive {
            border: 2px solid #90cdf4;
            background-color: #2d3748;
        }
         .lobule-base-interactive:hover::after {
            content: attr(data-info);
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #3D3D3D;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            white-space: pre-wrap;
            z-index: 10;
            width: max-content;
            max-width: 250px;
            text-align: left;
        }
        .dark-mode .lobule-base-interactive:hover::after {
            background-color: #4a5568;
        }

        .cle-laa-interactive { width: 35px; height: 35px; background-color: rgba(216, 167, 127, 0.3); border: 1px dashed #D8A77F; border-radius: 50%; position: absolute; }
        .dark-mode .cle-laa-interactive { background-color: rgba(246, 173, 85, 0.3); border: 1px dashed #f6ad55; }
        .cle-dot-interactive { width: 8px; height: 8px; background-color: #D8A77F; border-radius: 50%; position: absolute; }
        .dark-mode .cle-dot-interactive { background-color: #f6ad55; }
        .ple-laa-interactive { width: 100%; height: 100%; background-color: rgba(216, 167, 127, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .dark-mode .ple-laa-interactive { background-color: rgba(246, 173, 85, 0.15); }
        .ple-vessel-interactive { width: 4px; height: 50px; background-color: rgba(164, 184, 196, 0.7); transform: rotate(45deg); position: absolute; }
        .dark-mode .ple-vessel-interactive { background-color: rgba(113, 128, 150, 0.7); }
        .ple-vessel-interactive::before { content: ''; width: 4px; height: 50px; background-color: rgba(164, 184, 196, 0.7); position: absolute; transform: rotate(90deg); }
        .dark-mode .ple-vessel-interactive::before { background-color: rgba(113, 128, 150, 0.7); }
        .pse-laa-interactive { width: 25px; height: 25px; background-color: rgba(216, 167, 127, 0.3); border: 1px dashed #D8A77F; border-radius: 50%; position: absolute; }
        .dark-mode .pse-laa-interactive { background-color: rgba(246, 173, 85, 0.3); border: 1px dashed #f6ad55; }
        .pse-laa-1-interactive { top: -8px; left: 30%; }
        .pse-laa-2-interactive { top: 50%; right: -12px; transform: translateY(-50%); }
        .pse-laa-3-interactive { bottom: -8px; left: 40%; }

        .diff-diag-container { display: flex; justify-content: space-around; margin-top: 1rem; gap: 1rem; }
        .diff-diag-item { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 0.5rem; border: 极简 border: 1px solid #A4B8C4; border-radius: 0.5rem; transition: all 0.3s ease; }
        .dark-mode .diff-diag-item { border: 1px solid #4a5568; }
        .diff-diag-shape { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; background-color: #fff; border: 2px solid transparent; transition: all 0.3s ease; }
        .dark-mode .diff极简diag-shape { background-color: #2d3748; }
        .emphysema-no-wall-diag { border-color: #D8A77F; border-style: dashed; border-radius: 30%; }
        .dark-mode .emphysema-no-wall-diag { border-color: #f6ad55; }
        .true-cyst-wall-diag { border-color: #8AA399; border-style: solid; border-radius: 50%; }
        .dark-mode .true-cyst-wall-diag { border-color: #68d391; }
        .paracicatricial-diag .scar-diag { width: 25px; height: 60px; background-color: #A4B8C4; margin-right: -5px; z-index:0; transition: all 0.3s ease; }
        .dark-mode .paracicatricial-diag .scar-diag { background-color: #718096; }
        .paracicatricial-diag .emphysema-adj-diag { width: 45px; height: 45px; border: 2px dashed #D8A77F; border-radius: 20% 50% 50% 20%; z-index:1; transition: all 0.3s ease; }
        .dark-mode .paracicatricial-diag .emphysema-adj-diag { border: 2px dashed #f6ad55; }
        .honeycomb-diag-container { display: flex; flex-wrap: wrap; width: 80px; height: 80px; align-content: flex-start; justify-content: center; }
        .honeycomb-cyst-diag { width: 22px; height: 22px; border: 2px solid #8AA399; border-radius: 30%; margin:1px; background-color: rgba(138, 163, 153, 0.1); transition: all 0.3s ease; }
        .dark-mode .honeycomb-cyst-diag { border: 2px solid #68d391; background-color: rgba(104, 211, 145, 0.1); }

        .expandable-item .expand-content { display: none; margin-left: 1.5rem; margin-top: 0.5rem; padding-left: 1rem; border-left: 2px solid #A4B8C4; transition: all 0.3s ease; }
        .dark-mode .expandable-item .expand-content { border-left: 2px solid #4a5568; }
        .expandable-item.open .expand-content { display: block; }
        .expandable-item .expand-trigger { cursor: pointer; display: flex; align-items: center; }
        .expandable-item .expand-trigger::before { content: '▶'; margin-right: 0.5rem; transition: transform 0.2s; font-size: 0.8em; color: #6A8EAE; }
        .dark-mode .expandable-item .expand-trigger::before { color: #90cdf4; }
        .expandable-item.open .expand-trigger::before { transform: rotate(90deg); }

        .ai-input-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #A4B8C4;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            background-color: white;
            color: #3D3D3D;
            transition: all 0.3s ease;
        }
        .dark-mode .ai-input-textarea {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        .ai-button {
            background-color: #79A2A0; /* AI Accent Color */
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .ai-button:hover {
            background-color: #608381; /* Darker AI Accent */
        }
        .dark-mode .ai-button {
            background-color: #4fd1c5;
        }
        .dark-mode .ai-button:hover {
            background-color: #38b2ac;
        }
        .ai-result-area {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #FDFBF7;
            border: 1px solid #E6EBF0;
            border-radius: 0.5rem;
            min-height: 100px;
            white-space: pre-wrap; /* To respect newlines from API */
            font-size: 0.9rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        .dark-mode .ai-result-area {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        .loading-indicator {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 1rem;
            color: #6A8EAE;
        }
        .dark-mode .loading-indicator {
            color: #90cdf4;
        }
        .ai-disclaimer {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .dark-mode .ai-disclaimer {
            color: #a0aec0;
        }
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #3D3D3D;
        }
        .dark-mode .theme-toggle {
            color: #e2e8f0;
        }
        .feature-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: #D8A77F;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
        }
        .dark-mode .feature-badge {
            background-color: #f6ad55;
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #38b2ac;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <button id="themeToggle" class="theme-toggle">🌙</button>
    <div class="notification" id="notification"></div>

    <header class="text-center mb-8 relative">
        <span class="feature-badge">运科一班冯熠</span>
        <h1 class="text-3xl md:text-4xl font-bold" style="color: #6A8EAE;">肺气肿HRCT影像交互指南</h1>
        <p class="text-md text-gray-700 mt-1 dark:text-gray-300">高分辨率CT在肺气肿诊断与评估中的应用 (运科一班冯熠)</p>
    </header>

    <nav class="flex flex-wrap justify-center border-b-2 border-gray-200 mb-6 dark:border-gray-700">
        <button class="tab-button active" onclick="showSection('overview')">概述</button>
        <button class="tab-button" onclick="showSection('mainSubtypes')">主要亚型</button>
        <button class="tab-button" onclick="showSection('comparison')">对比与分布</button>
        <button class="tab-button" onclick="showSection('otherTypes')">其他相关类型</button>
        <button class="tab-button" onclick="showSection('associatedSigns')">伴随征象</button>
        <button class="tab-button" onclick="showSection('diffDiagnosis')">鉴别诊断</button>
        <button class="tab-button" onclick="showSection('aiAssistant')">✨ AI助手</button>
    </nav>

    <main class="max-w-7xl mx-auto">
        <section id="overview" class="content-section active">
            <div class="card">
                <h2 class="card-title">欢迎来到肺气肿HRCT影像交互指南</h2>
                <p class="mb-4 dark:text-gray-300">本指南旨在通过交互式的方式，帮助您理解肺气肿的定义、不同亚型在高分辨率CT（HRCT）中的典型影像学表现，以及相关的临床和影像学特征。肺气肿是一种常见的慢性肺部疾病，准确的影像学评估对于诊断、分型和指导治疗至关重要。此版本新增AI助手功能，可辅助文本解读和病例学习。</p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="sub-card-title">什么是肺气肿？</h3>
                        <极简p class="dark:text-gray-300">肺气肿的病理学定义为终末细支气管远端气腔的异常永久性扩大，伴有肺泡壁的破坏，通常无明显肺纤维化。它是慢性阻塞性肺疾病（COPD）的一种主要类型，与长期吸烟等危险因素密切相关。</p>
                    </div>
                    <div>
                        <h3 class="sub-card-title">HRCT的作用</h3>
                        <p class="dark:text-gray-300">高分辨率CT（HRCT）是评估肺气肿的首选影像学方法。它能够清晰显示肺部微细结构，准确识别肺气肿的类型、范围和严重程度，甚至在早期阶段即可检出病变。HRCT对于临床前肺气肿的发现、肺癌筛查中的风险评估以及指导个体化治疗方案均具有重要价值。</p>
                    </div>
                </div>
                 <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">请使用上方导航栏切换不同章节，深入了解肺气肿的HRCT影像学表现，或尝试新的"AI助手"功能。</p>
            </div>
        </section>

        <section id="mainSubtypes" class="content-section">
            <div class="card">
                <h2 class="card-title">主要肺气肿亚型</h2>
                <p class="mb-6 dark:text-gray-300">肺气肿根据其在次级肺小叶内的累及部位和范围，主要分为小叶中心型（CLE）、全小叶型（PLE）和间隔旁型（PSE）。了解这些亚型的特征对于准确诊断至关重要。</p>
                <article class="mb-8 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title" style="color:#D8A77F;">小叶中心型肺气肿 (Centrilobular Emphysema, CLE)</h3>
                    <div class="grid md:grid-cols-3 gap-6 items-start">
                        <div class="md:col-span-2">
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">核心特征：</strong>最常见，与吸烟密切相关。病变起始于次级肺小叶中央（呼吸性细支气管水平）。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT分布：</strong>典型表现为<span class="highlight">肺上叶为主</span>、分布不均。病灶与胸膜面及小叶间隔保持距离。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT形态：</strong></p>
                            <ul class="list-disc list-inside ml-4 space-y-1 text-sm dark:text-gray-300">
                                <li>局灶性低密度区（LAA），通常<span class="highlight">无壁或壁极薄</span>。</li>
                                <li>LAA中央常可见"<span class="highlight">中央点征</span>"（小叶中央动脉）。</li>
                                <li>早期边界不清，晚期因周围肺组织受压边界相对清晰。</li>
                                <li>晚期可融合，但小叶边缘肺实质常保留。</li>
                            </ul>
                        </div>
                        <div class="diagram-container">
                            <p class="diagram-title">CLE示意图 (悬停查看)</p>
                            <div class="lobule-base-interactive" data-info="小叶中心型 (CLE): 病变位于小叶中央，围绕呼吸性细支气管。可见中央点（动脉）和无壁/薄壁的低密度区。">
                                <div class="cle-laa-interactive"></div>
                                <div class="cle-dot-interactive"></div>
                            </div>
                            <p class="text-xs text-center mt-2 dark:text-gray-300">示意图展示了小叶中心区域的低密度改变和中央小动脉。</p>
                        </div>
                    </div>
                </article>
                <article class="mb-8 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title" style="color:#D8A77F;">全小叶型肺气肿 (Panlobular Emphysema, PLE)</h3>
                     <div class="grid md:grid-cols-3 gap-6 items-start">
                        <div class="md:col-span-2">
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">核心特征：</strong>整个次级肺小叶（肺腺泡）一致性破坏。典型病因为α1抗胰蛋白酶缺乏症。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT分布：</strong>通常弥漫性改变，以<span class="highlight">双肺下叶最为严重</span>。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT形态：</strong></p>
                            <ul class="list-disc list-inside ml-4 space-y-1 text-sm dark:text-gray-300">
                                <li>弥漫性、均匀的肺实质密度减低（"<span class="highlight">黑肺</span>"外观）。</li>
                                <li>肺血管纹理稀疏、纤细，数量减少 ("<span class="highlight">血管影减少征</span>")。</li>
                                <li>轻度PLE可能非常隐匿，诊断困难。</li>
                            </ul>
                        </div>
                        <div class="diagram-container">
                            <p class="diagram-title">PLE示意图 (悬停查看)</p>
                            <div class="lobule-base-interactive" data-info="全小叶型 (PLE): 整个次级肺小叶均匀受累，导致弥漫性密度减低和血管影稀疏。">
                                <div class="ple-laa-interactive">
                                    <div class="ple-vessel-interactive"></div>
                                </div>
                            </div>
                             <p class="text-xs text-center mt-2 dark:text-gray-300">示意图展示了整个小叶的弥漫性低密度和血管影减少。</p>
                        </div>
                    </div>
                </article>
                <article class="p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title" style="color:#D8A77F;">间隔旁型肺气肿 (Paraseptal Emphysema, PSE)</h3>
                    <div class="grid md:grid-cols-3 gap-6 items-start">
                        <div class="md:col-span-2">
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">核心特征：</strong>累及腺泡远端，紧邻胸膜表面和肺小叶间隔。常与吸烟有关。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT分布：极简</strong>特征性分布于<span class="highlight">胸膜下</span>，尤其好发于肺上叶背侧、纵隔旁等。</p>
                            <p class="mb-2 dark:text-gray-300"><strong class="highlight">HRCT形态：</strong></p>
                            <ul class="list-disc list-inside ml-4 space-y-1 text-sm dark:text-gray-300">
                                <li>邻近胸膜或小叶间隔的<span class="highlight">单层或多层薄壁</span>含气囊腔。</li>
                                <li>囊腔直径>1cm时称为<span class="highlight">肺大疱</span>。PSE极易形成肺大疱。</li>
                                <li>易导致<span class="highlight">自发性气胸</span>。</li>
                            </ul>
                        </div>
                        <div class="diagram-container">
                            <p class="diagram-title">PSE示意图 (悬停查看)</p>
                            <div class="lobule-base-interactive" data-info="间隔旁型 (PSE): 病变位于小叶边缘，紧邻胸膜或小叶间隔，常形成薄壁囊腔或肺大疱。">
                                <div class="pse-laa-interactive pse-laa-1-interactive"></div>
                                <div class="pse-laa-interactive pse-laa-2-interactive"></div>
                                <div class="pse-laa-interactive pse-laa-3-interactive"></div>
                            </div>
                            <p class="text-xs text-center mt-2 dark:text-gray-300">示意图展示了小叶边缘、胸膜下区域的薄壁囊腔。</p>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <section id="comparison" class="content-section">
            <div class="card">
                <h2 class="card-title">亚型对比与肺叶分布</h2>
                <p class="mb-4 dark:text-gray-300">本节对三种主要肺气肿亚型的关键HRCT特征进行总结对比，并通过图表形式示意性展示它们在肺叶中的常见分布趋势。</p>
                <h3 class="sub-card-title">HRCT特征比较表</h3>
                <p class="text-sm text-gray-600 mb-2 dark:text-gray-400">下表总结了小叶中心型（CLE）、全小叶型（PLE）和间隔旁型（PSE）肺气肿的关键HRCT鉴别特征和临床关联。</p>
                <div class="overflow-x-auto">
                    <table class="table-custom" id="emphysemaComparisonTable">
                        <thead>
                            <tr>
                                <th>特征</th>
                                <th>小叶中心型 (CLE)</th>
                                <th>全小叶型 (PLE)</th>
                                <th>间隔旁型 (PSE)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3 class="sub-card-title mt-8">肺叶分布趋势示意图</h3>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">此图表基于典型描述，示意性展示各主要亚型在上下肺叶的常见累及程度。请注意这仅为趋势示意，个体差异可能存在。</p>
                <div class="chart-container">
                    <canvas id="lobeDistributionChart"></canvas>
                </div>
            </div>
        </section>

        <section id="otherTypes" class="content-section">
            <div class="card">
                <h2 class="card-title">其他肺气肿相关疾病</h2>
                <p class="mb-6 dark:text-gray-300">除了三种经典亚型，HRCT还有助于识别其他与肺气肿相关的病理状态，如大疱性肺气肿、不规则/瘢痕旁肺气肿以及合并肺纤维化和肺气肿（CPFE）综合征。</p>
                <div id="otherTypesContainer" class="space-y-6"></div>
            </div>
        </section>

        <section id="associatedSigns" class="content-section">
            <div class="card">
                <h2 class="card-title">关键伴随HRCT征象</h2>
                <p class="mb-6 dark:text-gray-300">除了肺实质本身的低密度改变外，HRCT还能显示与肺气肿相关的其他重要征象，包括气道异常、肺动脉高压的间接征象以及呼气相的气体滞留。点击条目可展开查看详细信息。</p>
                <div id="associatedSignsContainer" class="space-y-4"></div>
            </div>
        </section>

        <section id="diffDiagnosis" class="content-section">
            <div class="card">
                <h2 class="card-title">HRCT上的关键鉴别诊断</h2>
                <p class="mb-6 dark:text-gray-300">准确识别肺气肿亚型并将其与其他表现相似的肺部疾病区分开来，对于指导临床决策至关重要。以下是一些关键的鉴别点。</p>
                <article class="mb-8 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title">肺气肿性腔隙 vs. 真性囊肿 (如LCH, LAM)</h3>
                    <p class="mb-2 dark:text-gray-300">关键鉴别点在于"<strong class="highlight">壁</strong>"：</p>
                    <ul class="list-disc list-inside ml-4 space-y-1 text-sm mb-4 dark:text-gray-300">
                        <li><strong>肺气肿：</strong>低密度区（LAA）通常<span class="highlight">缺乏可见壁</span>，或壁极薄、难以察觉。</li>
                        <li><strong>真性囊肿：</strong>具有<span class="highlight">清晰可辨的、完整的壁</span>（通常1-2mm厚）。</li>
                    </ul>
                    <div class="diff-diag-container">
                        <div class="diff-diag-item">
                            <div class="diff-diag-shape emphysema-no-wall-diag"></div>
                            <p class="font-semibold mt-1 dark:text-gray-300">肺气肿 LAA</p>
                            <p class="text-xs dark:text-gray-400">(无壁/壁极薄)</p>
                        </div>
                        <div class="diff-diag-item">
                            <div class="diff-diag-shape true-cyst-wall-diag"></div>
                            <p class="font-semibold mt-1 dark:text-gray-300">真性囊肿</p>
                            <p class="text-xs dark:text-gray-400">(有清晰可见壁)</p>
                        </div>
                    </div>
                    <p class="text-xs text-center mt-2 dark:text-gray-400">示意图对比：左侧为肺气肿性低密度区（通常无壁），右侧为真性囊肿（具有清晰的壁）。</p>
                </article>
                <article class="mb-8 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title">不规则型（瘢痕旁）肺气肿 vs. 蜂窝肺</h3>
                     <p class="mb-2 dark:text-gray-300">这是一个重要且常有难度的鉴别点：</p>
                     <ul class="list-disc list-inside ml-4 space-y-1 text-sm mb-4 dark:text-gray-300">
                        <li><strong>瘢痕旁肺气肿：</strong>气肿腔隙邻近<span class="highlight">局灶性瘢痕</span>，形态可不规则，其"壁"可由瘢痕或受压肺组织构成。</li>
                        <li><strong>蜂窝肺：</strong>通常为<span class="highlight">成簇、胸膜下、壁较厚(1-3mm)、多层堆叠</span>的囊腔，是晚期弥漫性纤维化（如UIP型）的表现。</li>
                    </ul>
                    <div class="diff-diag-container">
                        <div class="diff-diag-item">
                            <div class="diff-diag-shape paracicatricial-diag flex items-center justify-center">
                                <div class="scar-diag"></div>
                                <div class="emphysema-adj-diag"></div>
                            </div>
                            <p class="font-semibold mt-1 dark:text-gray-300">瘢痕旁肺气肿</p>
                             <p class="text-xs dark:text-gray-400">(邻近局灶瘢痕)</p>
                        </div>
                        <div class="diff-diag-item">
                            <div class="diff-diag-shape honeycomb-diag-container">
                                <div class="honeycomb-cyst-diag"></div><div class="honeycomb-cyst-diag"></div><div class="honeycomb-cyst-diag"></div>
                                <div class="honeycomb-cyst-diag"></div><div class="honeycomb-cyst-diag"></div><div class="honeycomb-cyst-diag"></div>
                            </div>
                            <p class="font-semibold mt-1 dark:text-gray-300">蜂窝肺</p>
                            <p class="text-xs dark:text-gray-400">(成簇厚壁囊腔, 弥漫纤维化背景)</p>
                        </div>
                    </div>
                    <p class="text-xs text-center mt-2 dark:text-gray-400">示意图对比：左侧为瘢痕旁肺气肿（气腔邻近瘢痕），右侧为蜂窝肺（成簇厚壁囊腔，常堆叠）。</p>
                </article>
                 <article class="p-4 border border-gray极简-200 rounded-lg dark:border-gray-700">
                    <h3 class="sub-card-title">其他鉴别诊断点</h3>
                    <ul class="list-disc list-inside ml-4 space-y-1 text-sm dark:text-gray-300">
                        <li><strong>小叶中心型肺气肿 vs. 感染性细支气管炎（非树芽征）：</strong>前者慢性，与吸烟相关，可见中央点征；后者急性，可有炎症征象，需结合临床。</li>
                        <li><strong>轻度全小叶型肺气肿 vs. 正常肺/弥漫性低密度：</strong>前者HRCT表现隐匿，需仔细观察血管稀疏，可考虑QCT辅助。</li>
                    </ul>
                     <p class="text-xs text-gray-500 mt-2 dark:text-gray-400">准确鉴别需要综合影像特征、临床病史和可能的辅助检查。</p>
                </article>
            </div>
        </section>

        <section id="aiAssistant" class="content-section">
            <div class="card">
                <h2 class="card-title">✨ AI 助手</h2>
                <p class="mb-6 dark:text-gray-300">欢迎使用AI助手功能！这些工具旨在辅助您理解HRCT报告文本和学习病例。请注意，AI生成的内容仅供参考和学习，不能替代专业医疗建议。</p>

                <article class="mb-8 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="ai-feature-title">AI智能解读HRCT文本</h3>
                    <p class="text-sm text-gray-600 mb-2 dark:text-gray-400">请在下方文本框中粘贴HRCT报告中关于肺气肿的描述性文本，AI将尝试分析并提取关键信息。</p>
                    <textarea id="hrctTextInput" class="ai-input-textarea" placeholder="例如：双肺上叶可见多发小叶中心型低密度透亮区，部分融合，未见明确厚壁。余肺野清晰..."></textarea>
                    <button id="analyzeHrctTextButton" class="ai-button">✨ AI智能解读</button>
                    <div id="hrctAnalysisLoading" class="loading-indicator">AI正在分析中，请稍候...</div>
                    <div id="hrctAnalysisResult" class="ai-result-area" style="display: none;"></div>
                    <p class="ai-disclaimer">AI分析结果基于模型理解，可能存在不准确之处，请辩证看待。</p>
                </article>

                <article class="p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                    <h3 class="ai-feature-title">AI病例学习助手</h3>
                    <p class="text-sm text-gray-600 mb-2 dark:text-gray-400">请简要描述一个病例（例如：患者年龄、性别、主要症状、HRCT关键发现），AI将提供相关的学习提示和探讨方向。</p>
                    <textarea id="caseStudyInput" class="ai-input-textarea" placeholder="例如：男性，68岁，长期吸烟史，活动后气促。HRCT示双肺下叶为主弥漫性密度减低，血管影稀疏..."></textarea>
                    <button id="analyzeCaseStudyButton" class="ai-button">✨ AI学习提示</button>
                    <div id="caseStudyLoading" class="loading-indicator">AI正在生成学习提示，请稍候...</div>
                    <div id="caseStudyResult" class="ai-result-area" style="display: none;"></div>
                    <p class="ai-disclaimer">AI学习提示旨在启发思考，不构成诊断建议。</p>
                </article>
            </div>
        </section>

    </main>

    <footer class="text-center py-8 mt-12 border-t border-gray-300 dark:border-gray-700">
        <p class="text-sm text-gray-600 dark:text-gray-400">&copy; 2024 肺气肿HRCT影像交互指南。内容仅供学习参考，不作为临床诊断依据。AI功能结果仅供参考。</p>
    </footer>

    <script>
        // 暗黑模式切换
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark-mode');
            themeToggle.textContent = document.documentElement.classList.contains('dark-mode') ? '☀️' : '🌙';
        });
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? '#e53e3e' : '#38b2ac';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 标签切换功能
        const sections = document.querySelectorAll('.content-section');
        const tabButtons = document.querySelectorAll('.tab-button');

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.getAttribute('onclick').includes(sectionId));
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 比较表格数据
        const comparisonData = [
            { feature: "主要肺叶分布", cle: "上叶为主", ple: "下叶为主（尤其在AAT缺乏症中）；可弥漫分布", pse: "上叶多见，紧邻胸膜/间隔" },
            { feature: "次级肺小叶内分布", cle: "小叶中央", ple: "累及整个次级肺小叶", pse: "小叶边缘，胸膜下" },
            { feature: "低密度区形态", cle: "局灶性，常圆形/卵圆形；可见“中央点征”；无壁或壁不明显。", ple: "弥漫性密度减低；肺实质“简化”；肺血管影稀疏。", pse: "邻近胸膜/间隔的囊腔，边界清晰，常有薄壁。" },
            { feature: "相关肺大疱", cle: "可见，尤其在融合/晚期", ple: "不作为主要特征，除非晚期", pse: "非常常见，常为主要表现" },
            { feature: "关键临床联系", cle: "与吸烟密切相关", ple: "α1抗胰蛋白酶缺乏症（典型）", pse: "自发性气胸，孤立存在时常无症状" }
        ];

        // 填充比较表格
        function populateComparisonTable() {
            const tableBody = document.getElementById('emphysemaComparisonTable').getElementsByTagName('tbody')[0];
            comparisonData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().innerHTML = `<strong>${item.feature}</strong>`;
                row.insertCell().textContent = item.cle;
                row.insertCell().textContent = item.ple;
                row.insertCell().textContent = item.pse;
            });
        }
        
        // 处理图表标签
        function processChartLabel(label, maxLength = 16) {
            if (typeof label !== 'string' || label.length <= maxLength) return label;
            const words = label.split(/(\s+)/);
            const lines = [];
            let currentLine = '';
            for (const word of words) {
                if (word.trim() === '') { currentLine += word; continue; }
                if ((currentLine + word).length > maxLength && currentLine.trim().length > 0) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine += word;
                }
            }
            if (currentLine.trim().length > 0) lines.push(currentLine.trim());
            return lines.length > 0 ? lines : [label];
        }

        // 图表工具提示回调
        const chartTooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            return Array.isArray(label) ? label.join(' ') : label;
        };

        // 创建肺叶分布图表
        function createLobeDistributionChart() {
            const ctx = document.getElementById('lobeDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['小叶中心型 (CLE)', '全小叶型 (PLE)', '间隔旁型 (PSE)'].map(label => processChartLabel(label)),
                    datasets: [
                        { label: '上叶累及程度', data: [3, 1.5, 2.5], backgroundColor: '#D8A77F', borderColor: '#C68662', borderWidth: 1 },
                        { label: '下叶累及程度', data: [1, 3, 1.5], backgroundColor: '#8AA399', borderColor: '#6F8A7D', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '累及程度 (示意)' }, ticks: { callback: v => ['无','轻','中','重'][v] || '', color: '#3D3D3D' }, grid: { color: '#A4B8C4' } },
                        x: { ticks: { color: '#3D3D3D' }, grid: { display: false } }
                    },
                    plugins: { tooltip: { callbacks: { title: chartTooltipTitleCallback } }, legend: { position: 'top', labels: { color: '#3D3D3D' } } }
                }
            });
        }

        // 其他类型数据
        const otherTypesData = [
            { title: "大疱性肺气肿与肺大疱", icon: "💨", content: "<strong>肺大疱定义：</strong>直径≥1cm、壁薄（≤1mm）的含气囊腔。常位于胸膜下，尤以PSE常见。<br><strong>大疱性肺气肿：</strong>当肺大疱成为主要影像特征时。" },
            { title: "不规则型（瘢痕旁）肺气肿", icon: "🩹", content: "<strong>定义：</strong>邻近肺部瘢痕发生的肺气肿。<br><strong>HRCT表现：</strong>邻近瘢痕的局灶性肺气肿样透亮区。<br><strong>关键鉴别：</strong>需与蜂窝肺鉴别。" },
            { title: "合并肺纤维化和肺气肿 (CPFE)", icon: "🔄", content: "<strong>定义：</strong>肺气肿（上叶）和肺纤维化（下叶）同时存在。<br><strong>典型HRCT：</强>上叶肺气肿 + 下叶肺纤维化。<br><strong>临床特点：</strong>DLCO显著降低。" }
        ];
        
        // 伴随征象数据
        const associatedSignsData = [
            { title: "气道异常", icon: "🌬️", details: ["<strong>支气管壁增厚 (BWT)</strong>", "<strong>支气管/细支气管扩张</strong>", "<strong>小气道病变 (SAD) 征象</strong>"] },
            { title: "肺动脉高压 (PHT) 征象", icon: "❤️‍🩹", details: ["<strong>主肺动脉扩张</strong>", "<strong>右心室(RV)/右心房(RA)扩大</strong>", "<strong>室间隔变平或左偏</strong>"] },
            { title: "呼气相HRCT上的气体滞留", icon: "🔒", details: ["<strong>定义：</strong>呼气末肺实质密度增高不足。", "<strong>意义：</strong>小气道阻塞的确切征象。"] }
        ];

        // 创建可展开项目
        function createExpandableItem(itemData, containerId) {
            const container = document.getElementById(containerId);
            const article = document.createElement('article');
            article.className = 'expandable-item p-4 border border-gray-200 rounded-lg dark:border-gray-700';
            article.innerHTML = `
                <h3 class="sub-card-title expand-trigger text-lg">${itemData.icon ? itemData.icon + ' ' : ''}${itemData.title}</h3>
                <div class="expand-content text-sm space-y-1 dark:text-gray-300">
                    ${itemData.content ? `<p>${itemData.content}</p>` : ''}
                    ${itemData.details ? `<ul class="list-disc list-inside">${itemData.details.map(d => `<li>${d}</li>`).join('')}</ul>` : ''}
                </div>`;
            container.appendChild(article);
            article.querySelector('.expand-trigger').addEventListener('click', () => article.classList.toggle('open'));
        }

        // AI功能模拟
        function simulateAIResponse(prompt, isCaseStudy = false) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (isCaseStudy) {
                        resolve({
                            likely_diagnosis_emphysema: "全小叶型肺气肿 (PLE)",
                            key_hrct_features_to_note: [
                                "双肺下叶为主弥漫性密度减低",
                                "肺血管纹理稀疏、纤细",
                                "肺实质呈'黑肺'外观"
                            ],
                            further_learning_questions: [
                                "α1抗胰蛋白酶缺乏症在PLE诊断中的意义？",
                                "如何区分轻度PLE与正常肺组织？",
                                "PLE患者肺功能检查的典型表现？"
                            ],
                            potential_ddx: [
                                "淋巴管平滑肌瘤病 (LAM)",
                                "朗格汉斯细胞组织细胞增生症 (LCH)",
                                "支气管扩张症"
                            ]
                        });
                    } else {
                        resolve({
                            mentioned_emphysema_types: ["小叶中心型 (CLE)"],
                            key_findings: [
                                "双肺上叶多发小叶中心型低密度透亮区",
                                "部分融合区域",
                                "未见明确厚壁"
                            ],
                            potential_severity_indicators: [
                                "多发低密度区",
                                "部分融合区域",
                                "以上叶为主"
                            ],
                            associated_conditions_hints: [
                                "未见明显纤维化征象",
                                "未见明显肺大疱形成"
                            ],
                            summary: "HRCT表现符合典型的小叶中心型肺气肿，主要累及双肺上叶，可见多发低密度透亮区，部分区域融合，但未见明确厚壁。未发现明显肺大疱或纤维化征象。"
                        });
                    }
                }, 1500);
            });
        }

        // HRCT文本分析
        const hrctAnalysisButton = document.getElementById('analyzeHrctTextButton');
        const hrctTextInput = document.getElementById('hrctTextInput');
        const hrctAnalysisResultDiv = document.getElementById('hrctAnalysisResult');
        const hrctAnalysisLoadingDiv = document.getElementById('hrctAnalysisLoading');

        hrctAnalysisButton.addEventListener('click', async () => {
            const inputText = hrctTextInput.value.trim();
            if (!inputText) {
                showNotification("请输入HRCT文本描述", "error");
                return;
            }
            hrctAnalysisLoadingDiv.style.display = 'block';
            hrctAnalysisResultDiv.style.display = 'none';

            try {
                const result = await simulateAIResponse(inputText);
                hrctAnalysisLoadingDiv.style.display = 'none';
                hrctAnalysisResultDiv.style.display = 'block';

                let htmlOutput = `<h4 class="font-bold mb-2">AI智能解读结果：</h4>`;
                htmlOutput += `<p><strong>总结：</strong> ${result.summary || '无'}</p>`;
                htmlOutput += `<p><strong>提及的肺气肿类型：</strong> ${result.mentioned_emphysema_types && result.mentioned_emphysema_types.length > 0 ? result.mentioned_emphysema_types.join('，') : '未提及或未能识别'}</p>`;
                htmlOutput += `<p><strong>关键影像学发现：</strong> ${result.key_findings && result.key_findings.length > 0 ? result.key_findings.join('； ') : '未提及或未能识别'}</p>`;
                htmlOutput += `<p><strong>可能的严重程度指标：</strong> ${result.potential_severity_indicators && result.potential_severity_indicators.length > 0 ? result.potential_severity_indicators.join('； ') : '未提及或未能识别'}</p>`;
                htmlOutput += `<p><strong>伴随疾病线索：</strong> ${result.associated_conditions_hints && result.associated_conditions_hints.length > 0 ? result.associated_conditions_hints.join('； ') : '未提及或未能识别'}</p>`;
                hrctAnalysisResultDiv.innerHTML = htmlOutput;
            } catch (e) {
                hrctAnalysisLoadingDiv.style.display = 'none';
                hrctAnalysisResultDiv.style.display = 'block';
                hrctAnalysisResultDiv.innerHTML = `<p class="text-red-600"><strong>AI分析出错：</strong> ${e.message}</p>`;
            }
        });

        // 病例学习分析
        const caseStudyButton = document.getElementById('analyzeCaseStudyButton');
        const caseStudyInput = document.getElementById('caseStudyInput');
        const caseStudyResultDiv = document.getElementById('caseStudyResult');
        const caseStudyLoadingDiv = document.getElementById('caseStudyLoading');

        caseStudyButton.addEventListener('click', async () => {
            const inputText = caseStudyInput.value.trim();
            if (!inputText) {
                showNotification("请输入病例简要描述", "error");
                return;
            }
            caseStudyLoadingDiv.style.display = 'block';
            caseStudyResultDiv.style.display = 'none';

            try {
                const result = await simulateAIResponse(inputText, true);
                caseStudyLoadingDiv.style.display = 'none';
                caseStudyResultDiv.style.display = 'block';

                let htmlOutput = `<h4 class="font-bold mb-2">AI病例学习助手提示：</h4>`;
                htmlOutput += `<p><strong>可能的肺气肿诊断/亚型：</strong> ${result.likely_diagnosis_emphysema || '未能确定'}</p>`;
                htmlOutput += `<p><strong>值得注意的关键HRCT特征：</strong></p><ul class="list-disc list-inside pl-4">${result.key_hrct_features_to_note && result.key_hrct_features_to_note.length > 0 ? result.key_hrct_features_to_note.map(f => `<li>${f}</li>`).join('') : '<li>未能识别具体特征</li>'}</ul>`;
                htmlOutput += `<p class="mt-2"><strong>进一步学习问题/探讨方向：</strong></p><ul class="list-disc list-inside pl-4">${result.further_learning_questions && result.further_learning_questions.length > 0 ? result.further_learning_questions.map(q => `<li>${q}</li>`).join('') : '<li>无特定建议</li>'}</ul>`;
                htmlOutput += `<p class="mt-2"><strong>可能的鉴别诊断方向：</strong></p><ul class="list-disc list-inside pl-4">${result.potential_ddx && result.potential_ddx.length > 0 ? result.potential_ddx.map(d => `<li>${d}</li>`).join('') : '<li>无特定建议</li>'}</ul>`;
                caseStudyResultDiv.innerHTML = htmlOutput;
            } catch (e) {
                caseStudyLoadingDiv.style.display = 'none';
                caseStudyResultDiv.style.display = 'block';
                caseStudyResultDiv.innerHTML = `<p class="text-red-600"><strong>AI学习提示生成出错：</strong> ${e.message}</p>`;
            }
        });
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            populateComparisonTable();
            createLobeDistributionChart();
            otherTypesData.forEach(item => createExpandableItem(item, 'otherTypesContainer'));
            associatedSignsData.forEach(item => createExpandableItem(item, 'associatedSignsContainer'));
            showSection('overview');
            
            // 为演示提供默认文本
            hrctTextInput.value = "双肺上叶可见多发小叶中心型低密度透亮区，部分融合，未见明确厚壁。余肺野清晰，肺血管纹理分布正常，未见明显肺大疱或纤维化征象。";
            caseStudyInput.value = "男性，68岁，长期吸烟史，活动后气促。HRCT示双肺下叶为主弥漫性密度减低，血管影稀疏，肺实质呈'黑肺'外观。";
        });
    </script>
</body>
</html>
